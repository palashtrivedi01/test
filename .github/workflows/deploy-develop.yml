name: Continuous Deployment (no-docker)

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # add host to known_hosts to avoid interactive prompt
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts
      - name: Copy jar to server
        run: |
          mkdir -p target
          # pick the first non-test jar in target
          JAR=$(ls target/*.jar 2>/dev/null | grep -v -E "(sources|javadoc)" | head -n1 || true)
          if [ -z "$JAR" ]; then
            echo "No jar found in target/ — failing"
            ls -l target || true
            exit 1
          fi
          scp -o StrictHostKeyChecking=no "$JAR" "${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}":~/app/app.jar
      - name: Restart app on server (kill port 8080 / app.jar and start with nohup)
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}" bash -s <<'SSH_SCRIPT'
            set -e
            mkdir -p ~/app
            echo "Stopping any process on port 8080 or running app.jar..."

            # Try to find PID by port (lsof), then fallback to pgrep for app.jar
            PID=""
            if command -v lsof >/dev/null 2>&1; then
              PID=$(lsof -ti:8080 2>/dev/null || true)
            fi

            if [ -z "$PID" ]; then
              PID=$(pgrep -f 'app.jar' || true)
            fi

            if [ -n "$PID" ]; then
              echo "Found PID(s): $PID — killing..."
              kill -9 $PID || true
              sleep 2
            else
              echo "No running app found on port 8080 or app.jar process."
            fi

            echo "Starting app with nohup (logging to ~/app/app.log)..."
            # ensure java is available on the server, redirect output to log, run in background
            nohup java -jar ~/app/app.jar > ~/app/app.log 2>&1 &

            echo "Done. Tail last 10 lines of log:"
            tail -n 10 ~/app/app.log || true
          SSH_SCRIPT